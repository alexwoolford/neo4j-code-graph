This page defines the nodes and relationships used by Neo4j Code Graph so new users can read and write queries confidently.

== Visual schema

image::schema/arrows-schema.png[Graph schema,align=center]

== Nodes

- *File*: A source file; properties include `path`, `total_lines`, `method_count`, `class_count`.
- *FileVer*: A versioned view of a file at a commit. Linked to `File` by `OF_FILE` and to `Commit` by `CHANGED`.
- *Method*: A function/method; key property `method_signature` plus `name`, `class_name`, `estimated_lines`, centrality scores.
- *Class*: A class declaration; `name`, `file`, flags (e.g., `is_abstract`).
- *Interface*: An interface declaration; `name`, `file`.
- *Import*: An import statement within a file; `import_path`.
- *ExternalDependency*: A third‑party package or module referenced by the code; properties include `package`, `version`.
- *Commit*: A Git commit; `sha`, `date`, `message`.
- *Developer*: An author; `name`, `email`.
- *CVE*: Vulnerability record (from NVD); `id`, `cvss_score`.
- *Directory*: A directory node used for hierarchical navigation; `path`.

== Relationships

// Core, high-frequency edges
- *`(Commit)-[:CHANGED]->(FileVer)`*: Git change written by a commit.
- *`(Commit)-[:PARENT]->(Commit)`*: Commit lineage; each commit points to its parent(s) (merge-aware).
- *`(FileVer)-[:OF_FILE]->(File)`*: Version points to its file.
- *`(Method)-[:CALLS]->(Method)`*: Static call graph edges.
- *`(Method)-[:SIMILAR]->(Method)`*: Semantic similarity from embeddings (`score`).
- *`(File)-[:DECLARES]->(Method)`*: File declares a method.
- *`(Class)-[:CONTAINS_METHOD]->(Method)`*: Method belongs to class.
- *`(Interface)-[:CONTAINS_METHOD]->(Method)`*: Method belongs to interface.
- *`(File)-[:IMPORTS]->(Import)`*: File contains an import declaration.
- *`(Import)-[:DEPENDS_ON]->(ExternalDependency)`*: Import maps to an external package.

// Type and hierarchy
- *`(Class)-[:EXTENDS]->(Class)`*: Inheritance between classes.
- *`(Interface)-[:EXTENDS]->(Interface)`*: Inheritance between interfaces.
- *`(Class)-[:IMPLEMENTS]->(Interface)`*: Class implements interface (the only cross‑type edge).
- *`(File)-[:DEFINES]->(Class|Interface)`*: File defines type declarations.
- *`(Directory)-[:CONTAINS]->(Directory)`*: Directory hierarchy.
- *`(Directory)-[:CONTAINS]->(File)`*: Files within a directory.

// People and security
- *`(Developer)-[:AUTHORED]->(Commit)`*: Author authored commit.
- *`(CVE)-[:AFFECTS]->(ExternalDependency)`*: Vulnerability affects dependency.

// Derived analyses
- *`(File)-[:CO_CHANGED]->(File)`*: Temporal coupling (co‑change) with `support` and `confidence`.

=== Relationship properties

- `(:Commit)-[:CHANGED]->(:FileVer)` stores:
  - `change_type` in {`added`,`modified`,`deleted`,`renamed`}
  - `additions` (Integer): lines added (from git numstat)
  - `deletions` (Integer): lines deleted (from git numstat)
  - `renamed_from` (String, optional): previous path when `change_type='renamed'`

== Method similarity (UniXcoder)

We embed `Method` nodes with *UniXcoder* to capture functional similarity beyond token overlap or call‑graph adjacency. UniXcoder learns from code, its AST, and comments, yielding embeddings that reflect what code does, not just how it’s spelled (ACL 2022).

- *Model*: UniXcoder (`microsoft/unixcoder-base`). See the paper: https://arxiv.org/abs/2203.03850[UniXcoder: Unified Cross‑Modal Pre‑training for Code Representation]. The encoder‑only embedding is 768‑dimensional.
- *Context length*: Up to ~1k tokens (`max_position_embeddings` ≈ 1026); longer methods are truncated.
- *Storage*: each `Method` stores its vector in `m.embedding_unixcoder` and the model tag in `m.embedding_type` (e.g., `unixcoder`).
- *Index + edges*: we create a Neo4j vector index on `Method.embedding_unixcoder` and run kNN to write `(:Method)-[:SIMILAR {score, model}]->(:Method)` using cosine similarity. Thresholds such as `topK` and `cutoff` are configurable.
- *Interpretation*: a higher `SIMILAR.score` implies closer intent‑level similarity in UniXcoder’s embedding space. Combine with `CALLS`, `IMPORTS/DEPENDS_ON`, and `CO_CHANGED` for stronger evidence.

NOTE: If you change the embedding model (e.g., switching to UniXcoder or between UniXcoder variants), re‑compute embeddings and rebuild the vector index before comparing results; embedding spaces are not interchangeable.

== Notes

- Schema constraints enforce key properties (e.g., `Method.method_signature`).
- For property and count examples, see the xref:queries/index.adoc[Queries catalog] and xref:architecture.adoc[Architecture] pages.

// BEGIN GENERATED: NODE_PROPERTIES

== Node properties (generated)

These property lists are generated from the live database via `db.schema.nodeTypeProperties()` and annotated with descriptions.

=== File
- `class_count` (Long): Number of class declarations in this file.
- `code_lines` (Long): Non-empty, non-comment lines of code (approximate).
- `ecosystem` (String): Build ecosystem (e.g., maven).
- `embedding_type` (String): Embedding model tag used to produce the vector.
- `embedding_unixcoder` (DoubleArray): Vector embedding for file content (if generated).
- `interface_count` (Long): Number of interface declarations in this file.
- `language` (String): Primary language detected for the file (e.g., java).
- `method_count` (Long): Number of method declarations in this file.
- `name` (String): File name (basename).
- `path` (String): Repository-relative file path (unique).
- `total_lines` (Long): Total number of lines in the file.

=== FileVer
- `path` (String): File path for this version (part of natural key).
- `sha` (String): Commit SHA that produced this file version (part of natural key).

=== Method
- `betweenness_score` (Double): Betweenness centrality score on the call graph.
- `class_name` (String): Declaring class name (if applicable).
- `containing_type` (String): Declaring type (class or interface) name when known.
- `embedding_type` (String): Embedding model tag used to produce the vector.
- `embedding_unixcoder` (DoubleArray): Vector embedding for method body (if generated).
- `estimated_lines` (Long): Approximate number of source lines in the method.
- `file` (String): Repository-relative file path containing the method.
- `id` (String): Internal identifier mirroring the signature for convenience.
- `in_degree` (Long): Number of distinct incoming CALLS.
- `is_abstract` (Boolean): True if the method is abstract.
- `is_final` (Boolean): True if the method is final.
- `is_private` (Boolean): True if the method is private.
- `is_public` (Boolean): True if the method is public.
- `is_static` (Boolean): True if the method is static.
- `line` (Long): Line number where the method starts.
- `method_signature` (String): Stable unique signature for the method (unique).
- `modifiers` (StringArray): List of Java modifiers present on the method.
- `name` (String): Method name.
- `out_degree` (Long): Number of distinct outgoing CALLS.
- `pagerank_score` (Double): PageRank centrality score on the call graph.
- `return_type` (String): Declared return type.
- `similarityCommunity` (Long): Community id from similarity clustering (Louvain).
- `total_degree` (Long): Sum of in_degree and out_degree.

=== Class
- `estimated_lines` (Long): Approximate number of lines spanned by the class.
- `file` (String): Repository-relative file path declaring the class.
- `is_abstract` (Boolean): True if the class is abstract.
- `is_final` (Boolean): True if the class is final.
- `line` (Long): Line number where the class starts.
- `modifiers` (StringArray): List of Java modifiers present on the class.
- `name` (String): Class name (unique with file).

=== Interface
- `file` (String): Repository-relative file path declaring the interface.
- `line` (Long): Line number where the interface starts.
- `method_count` (Long): Number of declared methods in the interface.
- `modifiers` (StringArray): List of Java modifiers present on the interface.
- `name` (String): Interface name (unique with file).

=== Import
- `import_path` (String): Imported type or package path (unique).
- `import_type` (String): One of internal|external (derived from analysis).
- `is_static` (Boolean): True for static imports.
- `is_wildcard` (Boolean): True if the import uses wildcard syntax (e.g., *).

=== ExternalDependency
- `ecosystem` (String): Dependency ecosystem (e.g., maven).
- `language` (String): Programming language associated with the dependency graph.
- `package` (String): Base package or coordinate identifying the dependency (unique).

=== Commit
- `date` (DateTime): Commit timestamp (datetime).
- `message` (String): Commit message.
- `sha` (String): Commit SHA (unique).

=== Developer
- `email` (String): Author email (unique).
- `name` (String): Author display name.

=== CVE
- `cvss_score` (Double): CVSS base score (0-10).
- `cvss_vector` (String): Derived or auxiliary property written by specific stages.
- `description` (String): Short description from NVD.
- `id` (String): CVE identifier (unique).
- `published` (String): Published date/time from NVD.
- `severity` (String): Severity classification (e.g., CRITICAL, HIGH).
- `updated_at` (DateTime): Derived or auxiliary property written by specific stages.

=== Directory
- `path` (String): Directory path relative to repository root (unique).
// END GENERATED: NODE_PROPERTIES
