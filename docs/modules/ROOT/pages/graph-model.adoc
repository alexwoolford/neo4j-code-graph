= Graph model

This page defines the nodes and relationships used by Neo4j Code Graph so new users can read and write queries confidently.

== Nodes

- *File*: A source file; properties include `path`, `total_lines`, `method_count`, `class_count`.
- *FileVer*: A versioned view of a file at a commit. Linked to `File` by `OF_FILE` and to `Commit` by `CHANGED`.
- *Method*: A function/method; key property `method_signature` plus `name`, `class_name`, `estimated_lines`, centrality scores.
- *Class*: A class declaration; `name`, `file`, flags (e.g., `is_abstract`).
- *Interface*: An interface declaration; `name`, `file`.
- *Import*: An import statement within a file; `import_path`.
- *ExternalDependency*: A third‑party package or module referenced by the code; properties include `package`, `version`.
- *Commit*: A Git commit; `sha`, `date`, `message`.
- *Developer*: An author; `name`, `email`.
- *CVE*: Vulnerability record (from NVD); `id`, `cvss_score`.
- *Directory*: A directory node used for hierarchical navigation; `path`.

== Relationships

// Core, high-frequency edges
- *`(Commit)-[:CHANGED]->(FileVer)`*: Git change written by a commit.
- *`(FileVer)-[:OF_FILE]->(File)`*: Version points to its file.
- *`(Method)-[:CALLS]->(Method)`*: Static call graph edges.
- *`(Method)-[:SIMILAR]->(Method)`*: Semantic similarity from embeddings (`score`).
- *`(File)-[:DECLARES]->(Method)`*: File declares a method.
- *`(Class)-[:CONTAINS_METHOD]->(Method)`*: Method belongs to class.
- *`(Interface)-[:CONTAINS_METHOD]->(Method)`*: Method belongs to interface.
- *`(File)-[:IMPORTS]->(Import)`*: File contains an import declaration.
- *`(Import)-[:DEPENDS_ON]->(ExternalDependency)`*: Import maps to an external package.

// Type and hierarchy
- *`(Class)-[:EXTENDS]->(Class)`*: Inheritance between classes.
- *`(Interface)-[:EXTENDS]->(Interface)`*: Inheritance between interfaces.
- *`(Class)-[:IMPLEMENTS]->(Interface)`*: Class implements interface (the only cross‑type edge).
- *`(File)-[:DEFINES]->(Class|Interface)`*: File defines type declarations.
- *`(Directory)-[:CONTAINS]->(Directory)`*: Directory hierarchy.
- *`(Directory)-[:CONTAINS]->(File)`*: Files within a directory.

// People and security
- *`(Developer)-[:AUTHORED]->(Commit)`*: Author authored commit.
- *`(CVE)-[:AFFECTS]->(ExternalDependency)`*: Vulnerability affects dependency.

// Derived analyses
- *`(File)-[:CO_CHANGED]->(File)`*: Temporal coupling (co‑change) with `support` and `confidence`.

== Method similarity (GraphCodeBERT)

We embed `Method` nodes with GraphCodeBERT to capture semantic similarity beyond token overlap.

- *Model*: GraphCodeBERT (see the original paper: https://arxiv.org/abs/2009.08366[GraphCodeBERT: Pre-training Code Representations with Data Flow]).
- *Storage*: each `Method` stores a 768‑dimensional vector in `m.embedding` and `m.embedding_type`.
- *Index + edges*: we create a Neo4j vector index and run kNN to write `SIMILAR` edges with a `score` property (cosine similarity). Thresholds such as `topK` and `cutoff` are configurable via `src/constants.py` or environment variables.
- *Interpretation*: a higher `SIMILAR.score` implies closer functional similarity according to GraphCodeBERT’s structure‑aware embedding space. Use these edges to find refactor candidates, duplicate logic, or related utilities; combine with explicit relations (`CALLS`, `IMPORTS/DEPENDS_ON`, `CONTAINS_METHOD`) for stronger evidence.

== Notes

- Schema constraints enforce key properties (e.g., `Method.method_signature`).
- For property and count examples, see the xref:queries/index.adoc[Queries catalog] and xref:architecture.adoc[Architecture] pages.
