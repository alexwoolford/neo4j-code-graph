= Graph model

This page defines the nodes and relationships used by Neo4j Code Graph so new users can read and write queries confidently.

== Nodes

- *File*: A source file; properties include `path`, `total_lines`, `method_count`, `class_count`.
- *FileVer*: A versioned view of a file at a commit. Linked to `File` by `OF_FILE` and to `Commit` by `CHANGED`.
- *Method*: A function/method; key property `method_signature` plus `name`, `class_name`, `estimated_lines`, centrality scores.
- *Class*: A class declaration; `name`, `file`, flags (e.g., `is_abstract`).
- *Interface*: An interface declaration; `name`, `file`.
- *Import*: An import statement within a file; `import_path`.
- *ExternalDependency*: A third‑party package or module referenced by the code; properties include `package`, `version`.
- *Commit*: A Git commit; `sha`, `date`, `message`.
- *Developer*: An author; `name`, `email`.
- *CVE*: Vulnerability record (from NVD); `id`, `cvss_score`.
- *Directory*: A directory node used for hierarchical navigation; `path`.

== Relationships

// Core, high-frequency edges
- *`(Commit)-[:CHANGED]->(FileVer)`*: Git change written by a commit.
- *`(FileVer)-[:OF_FILE]->(File)`*: Version points to its file.
- *`(Method)-[:CALLS]->(Method)`*: Static call graph edges.
- *`(Method)-[:SIMILAR]->(Method)`*: Semantic similarity from embeddings (`score`).
- *`(File)-[:DECLARES]->(Method)`*: File declares a method.
- *`(Class)-[:CONTAINS_METHOD]->(Method)`*: Method belongs to class.
- *`(Interface)-[:CONTAINS_METHOD]->(Method)`*: Method belongs to interface.
- *`(File)-[:IMPORTS]->(Import)`*: File contains an import declaration.
- *`(Import)-[:DEPENDS_ON]->(ExternalDependency)`*: Import maps to an external package.

// Type and hierarchy
- *`(Class)-[:EXTENDS]->(Class)`*: Inheritance between classes.
- *`(Interface)-[:EXTENDS]->(Interface)`*: Inheritance between interfaces.
- *`(Class)-[:IMPLEMENTS]->(Interface)`*: Class implements interface (the only cross‑type edge).
- *`(File)-[:DEFINES]->(Class|Interface)`*: File defines type declarations.
- *`(Directory)-[:CONTAINS]->(Directory)`*: Directory hierarchy.
- *`(Directory)-[:CONTAINS]->(File)`*: Files within a directory.

// People and security
- *`(Developer)-[:AUTHORED]->(Commit)`*: Author authored commit.
- *`(CVE)-[:AFFECTS]->(ExternalDependency)`*: Vulnerability affects dependency.

// Derived analyses
- *`(File)-[:CO_CHANGED]->(File)`*: Temporal coupling (co‑change) with `support` and `confidence`.

== Method similarity (UniXcoder)

We embed `Method` nodes with *UniXcoder* to capture functional similarity beyond token overlap or call‑graph adjacency. UniXcoder learns from code, its AST, and comments, yielding embeddings that reflect what code does, not just how it’s spelled (ACL 2022).

- *Model*: UniXcoder (`microsoft/unixcoder-base`). See the paper: https://arxiv.org/abs/2203.03850[UniXcoder: Unified Cross‑Modal Pre‑training for Code Representation]. The encoder‑only embedding is 768‑dimensional.
- *Context length*: Up to ~1k tokens (`max_position_embeddings` ≈ 1026); longer methods are truncated.
- *Storage*: each `Method` stores its vector in `m.embedding_unixcoder` and the model tag in `m.embedding_type` (e.g., `unixcoder`).
- *Index + edges*: we create a Neo4j vector index on `Method.embedding_unixcoder` and run kNN to write `(:Method)-[:SIMILAR {score, model}]->(:Method)` using cosine similarity. Thresholds such as `topK` and `cutoff` are configurable.
- *Interpretation*: a higher `SIMILAR.score` implies closer intent‑level similarity in UniXcoder’s embedding space. Combine with `CALLS`, `IMPORTS/DEPENDS_ON`, and `CO_CHANGED` for stronger evidence.

NOTE: If you change the embedding model (e.g., switching to UniXcoder or between UniXcoder variants), re‑compute embeddings and rebuild the vector index before comparing results; embedding spaces are not interchangeable.

== Notes

- Schema constraints enforce key properties (e.g., `Method.method_signature`).
- For property and count examples, see the xref:queries/index.adoc[Queries catalog] and xref:architecture.adoc[Architecture] pages.
